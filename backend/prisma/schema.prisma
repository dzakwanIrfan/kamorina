generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SettingType {
  NUMBER
  STRING
  BOOLEAN
  JSON
}

enum SettingCategory {
  MEMBERSHIP      // Keanggotaan
  SAVINGS         // Simpanan
  LOAN           // Pinjaman
  INTEREST       // Bunga
  PENALTY        // Denda
  GENERAL        // Umum
}

enum ApplicationStatus {
  UNDER_REVIEW
  APPROVED
  REJECTED
}

enum ApprovalStep {
  DIVISI_SIMPAN_PINJAM
  KETUA
}

enum ApprovalDecision {
  APPROVED
  REJECTED
}

enum EmployeeType {
  TETAP
  KONTRAK
}

model Employee {
  id              String        @id @default(uuid())
  employeeNumber  String        @unique @map("employee_number") // Nomor Induk Karyawan 9 digit
  fullName        String        @map("full_name")
  
  departmentId    String        @map("department_id")
  department      Department    @relation(fields: [departmentId], references: [id])
  
  golonganId      String        @map("golongan_id")
  golongan        Golongan      @relation(fields: [golonganId], references: [id])
  
  employeeType    EmployeeType  @map("employee_type")
  
  isActive        Boolean       @default(true) @map("is_active")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  users           User[]

  @@map("employees")
}

model User {
  id                      String    @id @default(uuid())
  name                    String
  email                   String    @unique
  nik                     String?   @unique // Nomor Induk Kependudukan angka 16 digit
  npwp                    String?   @unique // angka 16 digit
  password                String
  avatar                  String?

  // Link ke master karyawan (WAJIB, unik per user)
  employeeId              String    @unique @map("employee_id")
  employee                Employee  @relation(fields: [employeeId], references: [id])

  // Email Verification
  emailVerified           Boolean   @default(false) @map("email_verified")
  emailVerifiedAt         DateTime? @map("email_verified_at")
  emailVerificationToken  String?   @unique @map("email_verification_token")

  // Member Verification (flip true saat final approval)
  memberVerified          Boolean   @default(false) @map("member_verified")
  memberVerifiedAt        DateTime? @map("member_verified_at")

  // Additional Info (diisi pada step pengajuan member)
  dateOfBirth             DateTime? @map("date_of_birth") @db.Date
  birthPlace              String?   @map("birth_place")
  permanentEmployeeDate   DateTime? @map("permanent_employee_date") @db.Date
  installmentPlan         Int?      @map("installment_plan") // 1 or 2

  // Password Reset
  passwordResetToken      String?   @unique @map("password_reset_token")
  passwordResetExpires    DateTime? @map("password_reset_expires")

  // Timestamps
  createdAt               DateTime  @default(now()) @map("created_at")
  updatedAt               DateTime  @updatedAt @map("updated_at")

  roles                   UserRole[]
  memberApplications      MemberApplication[]
  approvals               ApplicationApproval[] @relation("approval_approver")
  applicationHistory      ApplicationHistory[]  @relation("history_processor")
  cooperativeSettings     CooperativeSetting[]

  @@map("users")
}

model MemberApplication {
  id             String            @id @default(uuid())
  userId         String            @map("user_id")
  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  status         ApplicationStatus @default(UNDER_REVIEW)
  currentStep    ApprovalStep?     @map("current_step")

  submittedAt    DateTime?         @map("submitted_at")
  approvedAt     DateTime?         @map("approved_at")
  rejectedAt     DateTime?         @map("rejected_at")
  rejectionReason String?          @map("rejection_reason")

  // Tracking submission
  submissionCount Int              @default(1) @map("submission_count")
  lastSubmittedAt DateTime?        @map("last_submitted_at")
  
  approvals      ApplicationApproval[]
  history        ApplicationHistory[]

  createdAt      DateTime          @default(now()) @map("created_at")
  updatedAt      DateTime          @updatedAt @map("updated_at")

  @@unique([userId])
  @@map("member_applications")
}

model ApplicationApproval {
  id             String           @id @default(uuid())
  applicationId  String           @map("application_id")
  application    MemberApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  step           ApprovalStep     @map("step")
  decision       ApprovalDecision? @map("decision")
  decidedAt      DateTime?        @map("decided_at")
  approverId     String?          @map("approver_id") // user id dari approver
  approver       User?            @relation("approval_approver", fields: [approverId], references: [id])
  notes          String?

  createdAt      DateTime         @default(now()) @map("created_at")

  @@map("application_approvals")
}

model ApplicationHistory {
  id             String            @id @default(uuid())
  applicationId  String            @map("application_id")
  application    MemberApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  // Snapshot data saat submit
  status         ApplicationStatus
  nik            String?
  npwp           String?
  dateOfBirth    DateTime?         @db.Date
  birthPlace     String?
  permanentEmployeeDate DateTime?  @db.Date
  installmentPlan Int?

  // Metadata
  submittedAt    DateTime          @map("submitted_at")
  rejectedAt     DateTime?         @map("rejected_at")
  approvedAt     DateTime?         @map("approved_at")
  rejectionReason String?          @map("rejection_reason")
  
  // Who processed (rejected/approved)
  processedBy    String?           @map("processed_by")
  processedByUser User?            @relation("history_processor", fields: [processedBy], references: [id])
  
  // Submission number
  submissionNumber Int             @default(1) @map("submission_number")

  createdAt      DateTime          @default(now()) @map("created_at")

  @@map("application_history")
}

model Department {
  id              String     @id @default(uuid())
  departmentName  String     @unique @map("department_name")
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  employees       Employee[]

  @@map("departments")
}

model Golongan {
  id          String     @id @default(uuid())
  golonganName String    @unique @map("golongan_name")
  description String?
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  employees   Employee[]

  @@map("golongan")
}

model Level {
  id          String   @id @default(uuid())
  levelName   String   @unique @map("level_name")
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  userRoles   UserRole[]

  @@map("levels")
}

model UserRole {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  levelId   String   @map("level_id")
  level     Level    @relation(fields: [levelId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([userId, levelId])
  @@map("user_roles")
}

model CooperativeSetting {
  id          String          @id @default(uuid())
  key         String          @unique // e.g., "initial_membership_fee"
  value       String          // Stored as string, parsed based on type
  type        SettingType     @default(STRING)
  category    SettingCategory
  
  label       String          // Label untuk UI: "Iuran Awal Anggota"
  description String?         // Deskripsi untuk helper text
  unit        String?         // e.g., "Rupiah", "Persen", "Hari"
  
  isEditable  Boolean         @default(true) @map("is_editable")
  isActive    Boolean         @default(true) @map("is_active")
  
  // Validation rules (stored as JSON)
  validation  Json?           // { "min": 0, "max": 100, "required": true }
  
  // Audit trail
  updatedBy   String?         @map("updated_by")
  updatedByUser User?         @relation(fields: [updatedBy], references: [id])
  
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")
  
  @@map("cooperative_settings")
}