generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SettingType {
  NUMBER
  STRING
  BOOLEAN
  JSON
}

enum SettingCategory {
  MEMBERSHIP      // Keanggotaan
  SAVINGS         // Simpanan
  LOAN           // Pinjaman
  INTEREST       // Bunga
  PENALTY        // Denda
  GENERAL        // Umum
}

enum ApplicationStatus {
  UNDER_REVIEW
  APPROVED
  REJECTED
}

enum ApprovalStep {
  DIVISI_SIMPAN_PINJAM
  KETUA
}

enum ApprovalDecision {
  APPROVED
  REJECTED
}

enum EmployeeType {
  TETAP
  KONTRAK
}

model Employee {
  id              String        @id @default(uuid())
  employeeNumber  String        @unique @map("employee_number")
  fullName        String        @map("full_name")
  
  departmentId    String        @map("department_id")
  department      Department    @relation(fields: [departmentId], references: [id])
  
  golonganId      String        @map("golongan_id")
  golongan        Golongan      @relation(fields: [golonganId], references: [id])
  
  employeeType    EmployeeType  @map("employee_type")
  
  isActive        Boolean       @default(true) @map("is_active")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  users           User[]

  @@map("employees")
}

model User {
  id                      String    @id @default(uuid())
  name                    String
  email                   String    @unique
  nik                     String?   @unique
  npwp                    String?   @unique
  password                String
  avatar                  String?
  bankAccountNumber       String?   @map("bank_account_number") 

  employeeId              String    @unique @map("employee_id")
  employee                Employee  @relation(fields: [employeeId], references: [id])

  emailVerified           Boolean   @default(false) @map("email_verified")
  emailVerifiedAt         DateTime? @map("email_verified_at")
  emailVerificationToken  String?   @unique @map("email_verification_token")
  emailVerificationExpires DateTime? @map("email_verification_expires")

  memberVerified          Boolean   @default(false) @map("member_verified")
  memberVerifiedAt        DateTime? @map("member_verified_at")

  dateOfBirth             DateTime? @map("date_of_birth") @db.Date
  birthPlace              String?   @map("birth_place")
  permanentEmployeeDate   DateTime? @map("permanent_employee_date") @db.Date
  installmentPlan         Int?      @map("installment_plan")

  passwordResetToken      String?   @unique @map("password_reset_token")
  passwordResetExpires    DateTime? @map("password_reset_expires")
  
  // Refresh token & security
  refreshToken            String?   @unique @map("refresh_token")
  refreshTokenExpires     DateTime? @map("refresh_token_expires")
  lastLoginAt             DateTime? @map("last_login_at")
  lastLoginIp             String?   @map("last_login_ip")
  failedLoginAttempts     Int       @default(0) @map("failed_login_attempts")
  accountLockedUntil      DateTime? @map("account_locked_until")

  createdAt               DateTime  @default(now()) @map("created_at")
  updatedAt               DateTime  @updatedAt @map("updated_at")

  roles                   UserRole[]
  memberApplications      MemberApplication[]
  approvals               ApplicationApproval[] @relation("approval_approver")
  applicationHistory      ApplicationHistory[]  @relation("history_processor")
  cooperativeSettings     CooperativeSetting[]
  
  loanApplications        LoanApplication[]
  loanApprovals          LoanApproval[] @relation("loan_approver")
  loanHistory            LoanHistory[] @relation("loan_processor")
  loanDisbursements      LoanDisbursement[] @relation("disbursement_processor")
  loanAuthorizations     LoanAuthorization[] @relation("authorization_processor")

  depositApplications     DepositApplication[]
  depositApprovals        DepositApproval[] @relation("deposit_approver")
  depositHistory          DepositHistory[] @relation("deposit_processor")
  
  // Session management
  sessions                UserSession[]

  @@map("users")
}

// Session management model
model UserSession {
  id            String    @id @default(uuid())
  userId        String    @map("user_id")
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  refreshToken  String    @unique @map("refresh_token")
  userAgent     String?   @map("user_agent") @db.Text
  ipAddress     String?   @map("ip_address")
  
  expiresAt     DateTime  @map("expires_at")
  lastUsedAt    DateTime  @default(now()) @map("last_used_at")
  
  createdAt     DateTime  @default(now()) @map("created_at")
  
  @@index([userId])
  @@index([refreshToken])
  @@map("user_sessions")
}

model MemberApplication {
  id             String            @id @default(uuid())
  userId         String            @map("user_id")
  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  status         ApplicationStatus @default(UNDER_REVIEW)
  currentStep    ApprovalStep?     @map("current_step")

  submittedAt    DateTime?         @map("submitted_at")
  approvedAt     DateTime?         @map("approved_at")
  rejectedAt     DateTime?         @map("rejected_at")
  rejectionReason String?          @map("rejection_reason")

  submissionCount Int              @default(1) @map("submission_count")
  lastSubmittedAt DateTime?        @map("last_submitted_at")
  
  approvals      ApplicationApproval[]
  history        ApplicationHistory[]

  createdAt      DateTime          @default(now()) @map("created_at")
  updatedAt      DateTime          @updatedAt @map("updated_at")

  @@unique([userId])
  @@map("member_applications")
}

model ApplicationApproval {
  id             String           @id @default(uuid())
  applicationId  String           @map("application_id")
  application    MemberApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  step           ApprovalStep     @map("step")
  decision       ApprovalDecision? @map("decision")
  decidedAt      DateTime?        @map("decided_at")
  approverId     String?          @map("approver_id")
  approver       User?            @relation("approval_approver", fields: [approverId], references: [id])
  notes          String?

  createdAt      DateTime         @default(now()) @map("created_at")

  @@map("application_approvals")
}

model ApplicationHistory {
  id             String            @id @default(uuid())
  applicationId  String            @map("application_id")
  application    MemberApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  status         ApplicationStatus
  nik            String?
  npwp           String?
  dateOfBirth    DateTime?         @db.Date
  birthPlace     String?
  permanentEmployeeDate DateTime?  @db.Date
  installmentPlan Int?

  submittedAt    DateTime          @map("submitted_at")
  rejectedAt     DateTime?         @map("rejected_at")
  approvedAt     DateTime?         @map("approved_at")
  rejectionReason String?          @map("rejection_reason")
  
  processedBy    String?           @map("processed_by")
  processedByUser User?            @relation("history_processor", fields: [processedBy], references: [id])
  
  submissionNumber Int             @default(1) @map("submission_number")

  createdAt      DateTime          @default(now()) @map("created_at")

  @@map("application_history")
}

model Department {
  id              String     @id @default(uuid())
  departmentName  String     @unique @map("department_name")
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  employees       Employee[]

  @@map("departments")
}

model Golongan {
  id              String              @id @default(uuid())
  golonganName    String              @unique @map("golongan_name")
  description     String?
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  employees       Employee[]
  loanLimits      LoanLimitMatrix[]

  @@map("golongan")
}

// Matrik Plafond Pinjaman
model LoanLimitMatrix {
  id                    String    @id @default(uuid())
  
  golonganId            String    @map("golongan_id")
  golongan              Golongan  @relation(fields: [golonganId], references: [id], onDelete: Cascade)
  
  // Masa kerja dalam tahun
  minYearsOfService     Int       @map("min_years_of_service") // 0, 1, 2, 3, 6
  maxYearsOfService     Int?      @map("max_years_of_service") // 1, 2, 3, 6, 9, null (untuk > 9)
  
  // Plafond maksimal pinjaman
  maxLoanAmount         Decimal   @map("max_loan_amount") @db.Decimal(15, 2)
  
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@unique([golonganId, minYearsOfService, maxYearsOfService])
  @@map("loan_limit_matrix")
}

model Level {
  id          String   @id @default(uuid())
  levelName   String   @unique @map("level_name")
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  userRoles   UserRole[]

  @@map("levels")
}

model UserRole {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  levelId   String   @map("level_id")
  level     Level    @relation(fields: [levelId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([userId, levelId])
  @@map("user_roles")
}

model CooperativeSetting {
  id          String          @id @default(uuid())
  key         String          @unique
  value       String
  type        SettingType     @default(STRING)
  category    SettingCategory
  
  label       String
  description String?
  unit        String?
  
  isEditable  Boolean         @default(true) @map("is_editable")
  isActive    Boolean         @default(true) @map("is_active")
  
  validation  Json?
  
  updatedBy   String?         @map("updated_by")
  updatedByUser User?         @relation(fields: [updatedBy], references: [id])
  
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")
  
  @@map("cooperative_settings")
}

enum LoanType {
  CASH_LOAN
  GOODS_REIMBURSE
  GOODS_ONLINE
  GOODS_PHONE
}

enum LoanStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW_DSP
  UNDER_REVIEW_KETUA
  UNDER_REVIEW_PENGAWAS
  APPROVED_PENDING_DISBURSEMENT
  DISBURSEMENT_IN_PROGRESS
  PENDING_AUTHORIZATION
  DISBURSED
  REJECTED
  CANCELLED
}

enum LoanApprovalStep {
  DIVISI_SIMPAN_PINJAM
  KETUA
  PENGAWAS
}

enum LoanApprovalDecision {
  APPROVED
  REJECTED
  REVISED
}

// Shared fields untuk semua jenis pinjaman
model LoanApplication {
  id                    String        @id @default(uuid())
  loanNumber            String        @unique @map("loan_number")
  
  // User reference
  userId                String        @map("user_id")
  user                  User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Loan type identifier
  loanType              LoanType      @map("loan_type") @default(CASH_LOAN)
  
  // Common fields for all loan types
  bankAccountNumber     String        @map("bank_account_number")
  loanAmount            Decimal       @map("loan_amount") @db.Decimal(15, 2)
  loanTenor             Int           @map("loan_tenor")
  loanPurpose           String        @map("loan_purpose") @db.Text
  attachments           Json?         // Array of file URLs
  
  // Calculated fields (set by DSP during approval)
  interestRate          Decimal?      @map("interest_rate") @db.Decimal(5, 2)
  monthlyInstallment    Decimal?      @map("monthly_installment") @db.Decimal(15, 2)
  totalRepayment        Decimal?      @map("total_repayment") @db.Decimal(15, 2)
  
  // Status tracking
  status                LoanStatus    @default(DRAFT)
  currentStep           LoanApprovalStep? @map("current_step")
  
  // Timestamps
  submittedAt           DateTime?     @map("submitted_at")
  approvedAt            DateTime?     @map("approved_at")
  rejectedAt            DateTime?     @map("rejected_at")
  disbursedAt           DateTime?     @map("disbursed_at")
  rejectionReason       String?       @map("rejection_reason") @db.Text
  
  // Revision tracking
  revisionCount         Int           @default(0) @map("revision_count")
  lastRevisedAt         DateTime?     @map("last_revised_at")
  lastRevisedBy         String?       @map("last_revised_by")
  revisionNotes         String?       @map("revision_notes") @db.Text
  
  // Relations to shared tables
  approvals             LoanApproval[]
  history               LoanHistory[]
  disbursement          LoanDisbursement?
  authorization         LoanAuthorization?
  
  // Relations to type-specific tables (1-to-1)
  cashLoanDetails       CashLoanDetail?
  goodsReimburseDetails GoodsReimburseDetail?
  goodsOnlineDetails    GoodsOnlineDetail?
  goodsPhoneDetails     GoodsPhoneDetail?
  
  createdAt             DateTime      @default(now()) @map("created_at")
  updatedAt             DateTime      @updatedAt @map("updated_at")
  
  @@index([userId])
  @@index([loanType])
  @@index([status])
  @@index([submittedAt])
  @@index([loanType, status])
  @@index([userId, loanType])
  @@map("loan_applications")
}

// TYPE-SPECIFIC TABLES

// 1. CASH LOAN (no additional fields needed, but for consistency)
model CashLoanDetail {
  id                String           @id @default(uuid())
  loanApplicationId String           @unique @map("loan_application_id")
  loanApplication   LoanApplication  @relation(fields: [loanApplicationId], references: [id], onDelete: Cascade)
  
  notes             String?          @db.Text
  
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")
  
  @@map("cash_loan_details")
}

// 2. GOODS REIMBURSE (Kredit Barang - Reimburse)
model GoodsReimburseDetail {
  id                String           @id @default(uuid())
  loanApplicationId String           @unique @map("loan_application_id")
  loanApplication   LoanApplication  @relation(fields: [loanApplicationId], references: [id], onDelete: Cascade)
  
  itemName          String           @map("item_name")
  itemPrice         Decimal          @map("item_price") @db.Decimal(15, 2)
  purchaseDate      DateTime         @map("purchase_date") @db.Date
  
  notes             String?          @db.Text
  
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")
  
  @@index([itemName])
  @@index([itemPrice])
  @@index([purchaseDate])
  @@map("goods_reimburse_details")
}

// 3. GOODS ONLINE (Kredit Barang - Online)
model GoodsOnlineDetail {
  id                String           @id @default(uuid())
  loanApplicationId String           @unique @map("loan_application_id")
  loanApplication   LoanApplication  @relation(fields: [loanApplicationId], references: [id], onDelete: Cascade)
  
  itemName          String           @map("item_name")
  itemPrice         Decimal          @map("item_price") @db.Decimal(15, 2)
  itemUrl           String           @map("item_url") @db.Text
  
  notes             String?          @db.Text
  
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")
  
  @@index([itemName])
  @@index([itemPrice])
  @@map("goods_online_details")
}

// 4. GOODS PHONE (Kredit Barang - Handphone dengan Partnership)
model GoodsPhoneDetail {
  id                String           @id @default(uuid())
  loanApplicationId String           @unique @map("loan_application_id")
  loanApplication   LoanApplication  @relation(fields: [loanApplicationId], references: [id], onDelete: Cascade)
  
  itemName          String           @map("item_name")
  retailPrice       Decimal          @map("retail_price") @db.Decimal(15, 2)
  cooperativePrice  Decimal          @map("cooperative_price") @db.Decimal(15, 2)
  
  notes             String?          @db.Text
  
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")
  
  @@index([itemName])
  @@index([retailPrice])
  @@index([cooperativePrice])
  @@map("goods_phone_details")
}

model LoanApproval {
  id                String              @id @default(uuid())
  loanApplicationId String              @map("loan_application_id")
  loanApplication   LoanApplication     @relation(fields: [loanApplicationId], references: [id], onDelete: Cascade)
  
  step              LoanApprovalStep
  decision          LoanApprovalDecision?
  decidedAt         DateTime?           @map("decided_at")
  approverId        String?             @map("approver_id")
  approver          User?               @relation("loan_approver", fields: [approverId], references: [id])
  notes             String?             @db.Text
  
  revisedData       Json?               @map("revised_data")
  
  createdAt         DateTime            @default(now()) @map("created_at")
  
  @@index([loanApplicationId])
  @@index([step])
  @@map("loan_approvals")
}

model LoanHistory {
  id                String              @id @default(uuid())
  loanApplicationId String              @map("loan_application_id")
  loanApplication   LoanApplication     @relation(fields: [loanApplicationId], references: [id], onDelete: Cascade)
  
  status            LoanStatus
  loanType          LoanType
  loanAmount        Decimal             @db.Decimal(15, 2)
  loanTenor         Int
  loanPurpose       String              @db.Text
  bankAccountNumber String
  interestRate      Decimal?            @db.Decimal(5, 2)
  monthlyInstallment Decimal?           @db.Decimal(15, 2)
  
  action            String
  actionAt          DateTime            @map("action_at")
  actionBy          String?             @map("action_by")
  actionByUser      User?               @relation("loan_processor", fields: [actionBy], references: [id])
  notes             String?             @db.Text
  
  createdAt         DateTime            @default(now()) @map("created_at")
  
  @@index([loanApplicationId])
  @@map("loan_history")
}

model LoanDisbursement {
  id                String           @id @default(uuid())
  loanApplicationId String           @unique @map("loan_application_id")
  loanApplication   LoanApplication  @relation(fields: [loanApplicationId], references: [id], onDelete: Cascade)
  
  processedBy       String           @map("processed_by")
  processedByUser   User             @relation("disbursement_processor", fields: [processedBy], references: [id])
  
  disbursementDate  DateTime         @map("disbursement_date")
  disbursementTime  String           @map("disbursement_time")
  
  notes             String?          @db.Text
  
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")
  
  @@map("loan_disbursements")
}

model LoanAuthorization {
  id                String           @id @default(uuid())
  loanApplicationId String           @unique @map("loan_application_id")
  loanApplication   LoanApplication  @relation(fields: [loanApplicationId], references: [id], onDelete: Cascade)
  
  authorizedBy      String           @map("authorized_by")
  authorizedByUser  User             @relation("authorization_processor", fields: [authorizedBy], references: [id])
  
  authorizationDate DateTime         @map("authorization_date")
  authorizationTime String           @map("authorization_time")
  
  notes             String?          @db.Text
  
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")
  
  @@map("loan_authorizations")
}

enum DepositAmount {
  AMOUNT_200K
  AMOUNT_500K
  AMOUNT_1000K
  AMOUNT_1500K
  AMOUNT_2000K
  AMOUNT_3000K
}

enum DepositTenor {
  TENOR_3
  TENOR_6
  TENOR_9
  TENOR_12
}

enum DepositStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW_DSP
  UNDER_REVIEW_KETUA
  APPROVED
  ACTIVE
  COMPLETED
  REJECTED
  CANCELLED
}

enum DepositApprovalStep {
  DIVISI_SIMPAN_PINJAM
  KETUA
}

enum DepositApprovalDecision {
  APPROVED
  REJECTED
}

model DepositApplication {
  id                    String               @id @default(uuid())
  depositNumber         String               @unique @map("deposit_number")
  
  userId                String               @map("user_id")
  user                  User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  depositAmount         DepositAmount        @map("deposit_amount")
  depositTenor          DepositTenor         @map("deposit_tenor")
  amountValue           Decimal              @map("amount_value") @db.Decimal(15, 2)
  tenorMonths           Int                  @map("tenor_months")
  
  interestRate          Decimal?             @map("interest_rate") @db.Decimal(5, 2)
  projectedInterest     Decimal?             @map("projected_interest") @db.Decimal(15, 2)
  totalReturn           Decimal?             @map("total_return") @db.Decimal(15, 2)
  
  agreedToTerms         Boolean              @default(false) @map("agreed_to_terms")
  
  status                DepositStatus        @default(DRAFT)
  currentStep           DepositApprovalStep? @map("current_step")
  
  submittedAt           DateTime?            @map("submitted_at")
  approvedAt            DateTime?            @map("approved_at")
  activatedAt           DateTime?            @map("activated_at")
  maturityDate          DateTime?            @map("maturity_date")
  completedAt           DateTime?            @map("completed_at")
  rejectedAt            DateTime?            @map("rejected_at")
  rejectionReason       String?              @map("rejection_reason") @db.Text
  
  approvals             DepositApproval[]
  history               DepositHistory[]
  
  createdAt             DateTime             @default(now()) @map("created_at")
  updatedAt             DateTime             @updatedAt @map("updated_at")

  @@map("deposit_applications")
}

model DepositApproval {
  id                    String                   @id @default(uuid())
  depositApplicationId  String                   @map("deposit_application_id")
  depositApplication    DepositApplication       @relation(fields: [depositApplicationId], references: [id], onDelete: Cascade)
  
  step                  DepositApprovalStep
  decision              DepositApprovalDecision?
  decidedAt             DateTime?                @map("decided_at")
  approverId            String?                  @map("approver_id")
  approver              User?                    @relation("deposit_approver", fields: [approverId], references: [id])
  notes                 String?                  @db.Text
  
  createdAt             DateTime                 @default(now()) @map("created_at")
  
  @@map("deposit_approvals")
}

model DepositHistory {
  id                    String             @id @default(uuid())
  depositApplicationId  String             @map("deposit_application_id")
  depositApplication    DepositApplication @relation(fields: [depositApplicationId], references: [id], onDelete: Cascade)
  
  status                DepositStatus
  depositAmount         DepositAmount
  depositTenor          DepositTenor
  amountValue           Decimal            @db.Decimal(15, 2)
  tenorMonths           Int
  interestRate          Decimal?           @db.Decimal(5, 2)
  projectedInterest     Decimal?           @db.Decimal(15, 2)
  
  action                String
  actionAt              DateTime           @map("action_at")
  actionBy              String?            @map("action_by")
  actionByUser          User?              @relation("deposit_processor", fields: [actionBy], references: [id])
  notes                 String?            @db.Text
  
  createdAt             DateTime           @default(now()) @map("created_at")
  
  @@map("deposit_history")
}